name: "Setup Rust Environment"
description: "Creates a Rust environment with the specified toolchain, cache, and dependencies"

inputs:
  cache-key:
    description: "Cache key used to retrieve built data. Usually matches the profile of the build"
    required: false
    default: "cache"
  
  install-deps:
    description: "Whether to install system dependencies. Set to false for self-hosted runners with pre-installed deps"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Set Rust version
      shell: bash
      run: |
        echo "BUILD_RUST_VERSION=$(rustc --version)" >> $GITHUB_ENV
    - name: Run sccache-cache
      uses: mozilla-actions/sccache-action@v0.0.9
    
    - name: Show sccache stats
      shell: bash
      run: sccache --show-stats
      
    - uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    # Install mold - always install locally to avoid sudo requirements
    - name: Install mold
      shell: bash
      run: |
        # Check if mold is already available and the right version
        MOLD_VERSION="2.40.4"
        if ! command -v mold &> /dev/null || [[ $(mold --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1) != "$MOLD_VERSION" ]]; then
          echo "Installing mold $MOLD_VERSION in ~/.local"
          mkdir -p ~/.local/bin
          wget -q -O- "https://github.com/rui314/mold/releases/download/v${MOLD_VERSION}/mold-${MOLD_VERSION}-$(uname -m)-linux.tar.gz" | \
            tar -xzf - -C ~/.local --strip-components=1
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
        else
          echo "mold is already installed: $(mold --version)"
        fi
        
        # Export the mold path for use in RUSTFLAGS
        MOLD_PATH=$(which mold)
        echo "MOLD_PATH=${MOLD_PATH}" >> $GITHUB_ENV
        echo "Mold installed at: ${MOLD_PATH}"
    
    # Install system dependencies only when install-deps is true
    - name: Install system dependencies
      if: inputs.install-deps == 'true'
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y libpq-dev libclang-dev
    
    # Install protoc only when install-deps is true
    - name: Install Protoc
      if: inputs.install-deps == 'true'
      uses: arduino/setup-protoc@v3
      with:
        repo-token: ${{ github.token }}