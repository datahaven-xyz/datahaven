name: Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    WORKING_DIR: operator
    RUSTFLAGS: "-C target-feature=+crt-static"
    CARGO_BUILD_JOBS: 4

jobs:
    check:
        name: Cargo Check
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler lld
                  protoc --version

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
                  targets: wasm32-unknown-unknown

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "cargo-check-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}"
                  prefix-key: |
                      ${{ runner.os }}-
                      ${{ hashFiles('**/Cargo.lock') }}
                      ${{ hashFiles('**/Cargo.toml') }}

            - name: Run cargo check
              run: |
                  export RUSTFLAGS="$RUSTFLAGS -C link-arg=-fuse-ld=lld"
                  cargo check --jobs ${{ env.CARGO_BUILD_JOBS }}

    fmt:
        name: Cargo Format
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
                  targets: wasm32-unknown-unknown

            - name: Check formatting
              run: cargo fmt --all -- --check

    test:
        name: Cargo Test
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y protobuf-compiler lld
                  protoc --version

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
                  targets: wasm32-unknown-unknown

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  shared-key: "cargo-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}"
                  prefix-key: |
                      ${{ runner.os }}-
                      ${{ hashFiles('**/Cargo.lock') }}
                      ${{ hashFiles('**/Cargo.toml') }}

            - name: Run tests
              run: |
                  export RUSTFLAGS="$RUSTFLAGS -C link-arg=-fuse-ld=lld"
                  cargo test --jobs ${{ env.CARGO_BUILD_JOBS }} --verbose
