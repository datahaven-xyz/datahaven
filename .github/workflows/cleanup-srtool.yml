name: Cleanup Srtool Cache

on:
  workflow_dispatch:
  push:
    branches:
      - fix/srtool-user

jobs:
  purge-srtool-cache:
    runs-on:
      group: DH-runners
    steps:
      - name: Remove srtool build artifacts
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          REPO_DIR="${REPO_NAME##*/}"
          TARGET_ROOT="${RUNNER_WORKSPACE}/${REPO_DIR}/operator/runtime"

          echo "Resolved runner workspace: ${RUNNER_WORKSPACE}"
          echo "Resolved repository directory: ${TARGET_ROOT}"

          if [ ! -d "$TARGET_ROOT" ]; then
            echo "Nothing to clean; $TARGET_ROOT does not exist."
            exit 0
          fi
          echo "Cleaning srtool directories under $TARGET_ROOT using ephemeral container"
          docker run --rm \
            -v "$TARGET_ROOT:/workspace" \
            alpine:3.19 \
            sh -c 'set -e; find /workspace -path "*/target/srtool" -prune -exec rm -rf {} +'
