name: "Task: Check Version Consistency"

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  check-versions:
    name: Check version consistency
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking initially

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: test/.bun-version

      - name: Install dependencies
        working-directory: test
        run: bun install --frozen-lockfile

      - name: Validate version formats and consistency
        working-directory: test
        run: bun run validate:versions

      - name: Check generated file is up-to-date
        working-directory: test
        run: |
          bun generate:version
          git diff --exit-code ../contracts/src/generated/Version.sol || \
            (echo "‚ùå Version.sol is out of sync. Run 'bun generate:version' and commit." && exit 1)
