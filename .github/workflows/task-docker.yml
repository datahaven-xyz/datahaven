name: Docker Build & Publish

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      image-tag:
        description: "The tag of the docker image"
        value: ${{ jobs.build-test-push.outputs.image-tag }}

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    env:
      RUSTC_WRAPPER: "sccache"
    outputs:
      image-tag: ${{ steps.last_tag_extractor.outputs.last_tag_value }}
    defaults:
      run:
        working-directory: operator

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
    
      - uses: ./.github/workflows/actions/cleanup-runner

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: moonsonglabs/datahaven
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short,prefix=sha-
            type=ref,event=tag
            type=ref,event=branch
            type=ref,event=pr

      - name: Extract last tag for job output
        id: last_tag_extractor
        run: |
          echo "last_tag_value=$(echo '${{ steps.meta.outputs.json }}' | jq -r '.tags[-1]')" >> $GITHUB_OUTPUT

      - name: Log Docker Metadata
        run: |
          echo "Generated tags: ${{ steps.meta.outputs.tags }}"
          echo "Generated labels: ${{ steps.meta.outputs.labels }}"
          echo "Generated JSON: ${{ steps.meta.outputs.json }}"

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Restore cacheâ€‘mount blobs
        uses: actions/cache@v4
        with:
          path: |
            cargo-registry
            cargo-git
            sccache
          key: ${{ runner.os }}-rust-buildkit-${{ hashFiles('operator/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-buildkit-
      - name: inject cache into docker
        uses: reproducible-containers/buildkit-cache-dance@v3.1.0
        with:
          cache-map: |
            {
              "cargo-registry": { "target": "/usr/local/cargo/registry" },
              "cargo-git":      { "target": "/usr/local/cargo/git" },
              "sccache":        { "target": "/sccache", "sharing": "locked" },
              "cargo-target":   { "target": "/datahaven/target" }
            }
      - name: Build Docker image (load for tests) with detailed cache logging
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./operator/Dockerfile
          load: true
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=datahaven-build
          cache-to: type=gha,mode=max,scope=datahaven-build

      - name: Log build cache statistics
        run: |
          echo "Build cache statistics:"
          docker buildx du --verbose

      # --- Smoke tests ---

      - name: Test node --help
        run: docker run --rm ${{ steps.last_tag_extractor.outputs.last_tag_value }} --help

      - name: Integration test (dev chain starts)
        run: |
          docker run --rm -d -p 9944:9944 --name local-dh-node \
            ${{ steps.last_tag_extractor.outputs.last_tag_value }} --dev --unsafe-rpc-external
      - name: Wait for node to be healthy and test
        run: |
          echo "Waiting for node to start..."
          for i in {1..30}; do # Retry for 30 * 5s = 150 seconds
            if curl --fail --location 'http://127.0.0.1:9944' \
              --header 'Content-Type: application/json' \
              --data '{"jsonrpc":"2.0","id":1,"method":"system_chain","params":[]}' ; then
              echo "Node is healthy!"
              docker logs local-dh-node --tail 100
              exit 0
            fi
            echo "Attempt $i: Node not ready yet, sleeping 5s..."
            sleep 5
          done
          echo "Node failed to start or respond in time."
          docker logs local-dh-node --tail 100
          exit 1
      - name: Cleanup integration test container
        if: always()
        run: docker rm -f local-dh-node

      - name: Copy build artifacts from container
        run: |
          docker cp local-dh-node:/tmp/cargo-timing.html ./cargo-timing.html || echo "Failed to copy cargo-timing.html"
          docker cp local-dh-node:/tmp/sccache_stats.log ./sccache_stats.log || echo "Failed to copy sccache_stats.log"

      - name: Upload cargo timing report
        uses: actions/upload-artifact@v4
        with:
          name: cargo-timing-report
          path: ./cargo-timing.html
          if-no-files-found: warn

      - name: Display sccache stats
        run: |
          echo "SCCACHE Stats:"
          cat ./sccache_stats.log || echo "sccache_stats.log not found"

      # --- Push to Docker Hub ---
      - name: Push Docker image with detailed cache logging
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./operator/Dockerfile
          push: false
          load: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=datahaven-build
          cache-to: type=gha,mode=max,scope=datahaven-build
          provenance: mode=max
          sbom: true

      - name: Log final build cache statistics
        run: |
          echo "Final build cache statistics:"
          docker buildx du --verbose
