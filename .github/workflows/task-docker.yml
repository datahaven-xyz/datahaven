name: Docker Build & Publish

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      image-tag:
        description: "The tag of the docker image"
        value: ${{ jobs.build-test-push.outputs.image-tag }}

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-push:
    # runs-on: ubuntu-latest
    runs-on: ubuntu-24.04-32core-128gb
    env:
      SCCACHE_GHA_ENABLED: true
    outputs:
      image-tag: ${{ steps.last_tag_extractor.outputs.last_tag_value }}
    defaults:
      run:
        working-directory: operator

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/workflows/actions/cleanup-runner

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: moonsonglabs/datahaven
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short,prefix=sha-
            type=ref,event=tag
            type=ref,event=branch
            type=ref,event=pr

      - name: Extract last tag for job output
        id: last_tag_extractor
        run: |
          echo "last_tag_value=$(echo '${{ steps.meta.outputs.json }}' | jq -r '.tags[-1]')" >> $GITHUB_OUTPUT

      - name: Log Docker Metadata
        run: |
          echo "Generated tags: ${{ steps.meta.outputs.tags }}"
          echo "Generated labels: ${{ steps.meta.outputs.labels }}"
          echo "Generated JSON: ${{ steps.meta.outputs.json }}"

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Cache Mount blobs
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            cargo-registry
            cargo-git
            sccache
          key: cache-mount-${{ hashFiles('./operator/Dockerfile', './operator/Cargo.lock') }}
          restore-keys: |
            cache-mount-${{ hashFiles('./operator/Dockerfile') }}
            cache-mount-
      - name: Create cache directories if they don't exist
        run: |
          mkdir -p cargo-registry cargo-git sccache
          echo "Created cache directories:"
          ls -la cargo-registry cargo-git sccache
      - name: inject cache into docker
        uses: reproducible-containers/buildkit-cache-dance@v3.1.0
        with:
          cache-map: |
            {
              "cargo-registry": { "target": "/usr/local/cargo/registry" },
              "cargo-git":      { "target": "/usr/local/cargo/git" },
              "sccache":        { "target": "/usr/local/sccache" }
            }
      - name: Build Docker image (load for tests) with detailed cache logging
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./operator/Dockerfile
          load: true
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          build-args: 
            RUSTC_WRAPPER=sccache
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=datahaven-build
          cache-to: type=gha,mode=max,scope=datahaven-build

      - name: Setup sccache binary using Mozilla-Actions/sccache-action
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          version: 'v0.10.0'

      - name: Report sccache statistics
        working-directory: operator
        env:
          SCCACHE_DIR: ${{ github.workspace }}/operator/sccache
        run: |
          echo "==== Sccache Statistics (using sccache from Mozilla Action) ===="
          echo "Attempting to read stats from SCCACHE_DIR: $SCCACHE_DIR"
          if [ ! -d "$SCCACHE_DIR" ]; then
            echo "Warning: SCCACHE_DIR ($SCCACHE_DIR) does not exist or is not a directory."
            echo "This might indicate an issue with the cache persistence from the Docker build."
            # sccache --show-stats might create it, or error. Let's allow it to try.
          else
            echo "Contents of SCCACHE_DIR ($SCCACHE_DIR):"
            ls -la "$SCCACHE_DIR"
          fi

          if [ -n "${SCCACHE_PATH}" ]; then
            echo "Using sccache from SCCACHE_PATH: ${SCCACHE_PATH}"
            ${SCCACHE_PATH} --show-stats
          elif command -v sccache &> /dev/null; then
            echo "SCCACHE_PATH not set or empty, using sccache from system PATH: $(command -v sccache)"
            sccache --show-stats
          else
            echo "Error: sccache command not found. Mozilla-Actions/sccache-action might not have set it up as expected."
            exit 1
          fi
          echo "================================================================="

      - name: Log build cache statistics
        run: |
          echo "Build cache statistics:"
          docker buildx du --verbose

      # --- Smoke tests ---

      - name: Test node --help
        run: docker run --rm ${{ steps.last_tag_extractor.outputs.last_tag_value }} --help

      - name: Integration test (dev chain starts)
        run: |
          docker run --rm -d -p 9944:9944 --name local-dh-node \
            ${{ steps.last_tag_extractor.outputs.last_tag_value }} --dev --unsafe-rpc-external

      - name: Wait for node to be healthy and test
        run: |
          echo "Waiting for node to start..."
          for i in {1..30}; do # Retry for 30 * 5s = 150 seconds
            if curl --fail --location 'http://127.0.0.1:9944' \
              --header 'Content-Type: application/json' \
              --data '{"jsonrpc":"2.0","id":1,"method":"system_chain","params":[]}' ; then
              echo "Node is healthy!"
              docker logs local-dh-node --tail 100
              exit 0
            fi
            echo "Attempt $i: Node not ready yet, sleeping 5s..."
            sleep 5
          done
          echo "Node failed to start or respond in time."
          docker logs local-dh-node --tail 100
          exit 1

      - name: Cleanup integration test container
        if: always()
        run: docker rm -f local-dh-node
      # --- Push to Docker Hub ---
      - name: Push Docker image with detailed cache logging
        uses: docker/build-push-action@v5
        with:
          context: ./
          file: ./operator/Dockerfile
          push: true
          load: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=datahaven-build
          cache-to: type=gha,mode=max,scope=datahaven-build
          provenance: mode=max
          sbom: true

      - name: Log final build cache statistics
        run: |
          echo "Final build cache statistics:"
          docker buildx du --verbose
