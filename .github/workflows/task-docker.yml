name: Docker Build

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      image-tag:
        description: "The tag of the docker image"
        value: ${{ jobs.remote.outputs.image-tag }}

jobs:
  local:
    runs-on: ubuntu-latest
    name: Build & Test Docker Image
    defaults:
      run:
        working-directory: operator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
            context: ./operator 
            file: ./operator/Dockerfile 
            push: false 
            load: true 
            tags: moonsonglabs/datahaven:local 
            cache-from: type=gha
            cache-to: type=gha,mode=max
      - name: Test node help
        run: docker run --rm moonsonglabs/datahaven:local --help
      - run: docker run --rm -d -p 9944:9944 --name local-dh-node moonsonglabs/datahaven:local --dev --unsafe-rpc-external 
      - run: sleep 60
      - run: docker logs local-dh-node
      - run: |
          curl --location 'http://127.0.0.1:9944' \
            --header 'Content-Type: application/json' \
            --data '{
                "jsonrpc":"2.0",
                "id"     :1,
                "method" :"system_chain",
                "params" :[]
            }'
    
  remote:
    needs: local
    runs-on: ubuntu-latest
    name: Publish Remote Image
    outputs:
      image-tag: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
    defaults:
      run:
        working-directory: operator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: moonsonglabs/datahaven
          flavor: |
            latest=auto
          tags: |
            type=sha,format=short,prefix=sha-
            type=ref
            

      - name: Log Docker Metadata
        run: |
          echo "Generated tags: ${{ steps.meta.outputs.tags }}"
          echo "Generated labels: ${{ steps.meta.outputs.labels }}"
          echo "Full JSON output: ${{ steps.meta.outputs.json }}"

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./operator
          file: ./operator/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max 

