# Rust Tests: CI for Rust components (DataHaven runtime and node Rust tests)
#
# Overview:
# 1. Prepare: This job handles the setup phase where the cargo nextest archive is created
#    and uploaded to the workflow for use in the subsequent jobs
# 2. All Rust Tests: Executes the full suite of Rust tests across two partitions to
#    to reduce total execution time.

name: DataHave Operator Rust Tests

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  actions: write

jobs:

  prepare:
    name: Prepare artifacts for Rust tests
    runs-on:
      group: DH-runners
    env:
      RUSTC_WRAPPER: "sccache"
      CARGO_INCREMENTAL: "0"
      CARGO_TERM_COLOR: always
      RUSTFLAGS: "-C linker=clang -C link-arg=-fuse-ld=mold"
      SCCACHE_GHA_ENABLED: "true"
    defaults:
      run:
        working-directory: ./operator
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - uses: ./.github/workflows/actions/setup-env
        with:
          cache-key: "TEST"
          install-deps: false  # Self-hosted runners have deps pre-installed
      # Cleanup-runner skipped on self-hosted runners (bare-metal manages disk space externally)
      - name: Install nextest
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "Installing cargo-nextest version 0.9.100"
            cargo install cargo-nextest --version 0.9.100 --locked
          else
            echo "cargo-nextest is already installed: $(cargo-nextest --version)"
          fi
      - name: Build and archive tests
        run: cargo nextest archive --archive-file nextest-archive.tar.zst
      - name: Upload archive to workflow
        uses: actions/upload-artifact@v4
        with:
          name: nextest-archive
          path: ./operator/nextest-archive.tar.zst
          retention-days: 1

  all-rust-tests:
    name: Run all Operator Rust tests (/w partitioning)
    needs: [prepare]
    runs-on:
      group: DH-runners
    strategy:
      fail-fast: false
      matrix:
        partition: [1, 2]
    defaults:
      run:
        working-directory: ./operator
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install nextest
        run: |
          if ! command -v cargo-nextest &> /dev/null; then
            echo "Installing cargo-nextest version 0.9.100"
            cargo install cargo-nextest --version 0.9.100 --locked
          else
            echo "cargo-nextest is already installed: $(cargo-nextest --version)"
          fi
      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: nextest-archive
      - name: Run Tests for All Projects!
        run: |
          ~/.cargo/bin/cargo-nextest nextest run \
            --archive-file ../nextest-archive.tar.zst \
            --partition count:${{ matrix.partition }}/2

  tests-result-checker:
    name: Check tests were successful
    needs: [all-rust-tests]
    runs-on:
      group: DH-runners
    steps:
      - name: Cleanup test artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: nextest-archive
      - name: Validate test results
        run: |
          echo "matrix result: ${{ needs.all-rust-tests.result }}"

          if [ "${{ needs.all-rust-tests.result }}" != "success" ]; then
            echo "Rust tests failed or were cancelled"
            exit 1
          else
            echo "Rust tests passed"
          fi

  cleanup-artifacts:
    name: Cleanup nextest artifacts
    needs: [prepare, all-rust-tests, tests-result-checker]
    if: always()
    runs-on:
      group: DH-runners
    timeout-minutes: 5
    permissions:
      actions: write
      contents: read
    steps:
      - name: Wait for artifact finalization
        run: sleep 20
      - name: Delete nextest-archive artifacts for this run
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.runId;
            const { owner, repo } = context.repo;
            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifacts = res.data.artifacts || [];
            const targets = artifacts.filter(a => a.name && a.name.startsWith('nextest-archive'));
            core.info(`Found ${targets.length} artifact(s) to delete`);
            const withTimeout = async (promise, ms) => {
              return await Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms)),
              ]);
            };
            for (const a of targets) {
              try {
                core.info(`Deleting artifact ${a.id} (${a.name})`);
                await withTimeout(
                  github.rest.actions.deleteArtifact({ owner, repo, artifact_id: a.id }),
                  10000
                );
              } catch (err) {
                core.warning(`Skip deleting ${a.id}: ${err?.message || err}`);
              }
            }

