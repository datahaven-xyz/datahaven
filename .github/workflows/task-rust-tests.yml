# Rust Tests: CI for Rust components (DataHaven runtime and node Rust tests)
#
# Overview:
# 1. Prepare: This job handles the setup phase where the cargo nextest archive is created
#    and uploaded to the workflow for use in the subsequent jobs
# 2. All Rust Tests: Executes the full suite of Rust tests across two partitions to
#    to reduce total execution time.

name: DataHaven Operator Rust Tests

on:
  workflow_dispatch:
  workflow_call:

jobs:

  prepare:
    name: Prepare artifacts for Rust tests
    runs-on:
      group: DH-runners
    env:
      RUSTC_WRAPPER: "sccache"
      CARGO_INCREMENTAL: "0"
      CARGO_TERM_COLOR: always
      RUSTFLAGS: "-C linker=clang -C link-arg=-fuse-ld=mold"
      SCCACHE_GHA_ENABLED: "true"
    defaults:
      run:
        working-directory: ./operator
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - uses: ./.github/workflows/actions/setup-env
        with:
          cache-key: "TEST"
          install-deps: false  # Self-hosted runners have deps pre-installed
      # Cleanup-runner skipped on self-hosted runners (bare-metal manages disk space externally)


  all-rust-tests:
    name: Run all Operator Rust tests (/w partitioning)
    needs: [prepare]
    runs-on:
      group: DH-runners
    env:
      RUSTC_WRAPPER: "sccache"
      CARGO_INCREMENTAL: "0"
      CARGO_TERM_COLOR: always
      RUSTFLAGS: "-C linker=clang -C link-arg=-fuse-ld=mold"
      SCCACHE_GHA_ENABLED: "true"
    strategy:
      fail-fast: false
      matrix:
        partition: [1, 2]
    defaults:
      run:
        working-directory: ./operator
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: ./.github/workflows/actions/setup-env
        with:
          cache-key: "TEST"
          install-deps: false  # Self-hosted runners have deps pre-installed
      - name: Run Tests for All Projects!
        run: |
          ~/.cargo/bin/cargo-nextest nextest run \
            --partition count:${{ matrix.partition }}/2

  tests-result-checker:
    name: Check tests were successful
    needs: [all-rust-tests]
    runs-on:
      group: DH-runners
    steps:
      - name: Validate test results
        run: |
          echo "matrix result: ${{ needs.all-rust-tests.result }}"

          if [ "${{ needs.all-rust-tests.result }}" != "success" ]; then
            echo "Rust tests failed or were cancelled"
            exit 1
          else
            echo "Rust tests passed"
          fi

