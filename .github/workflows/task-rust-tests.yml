# Rust Tests: CI for Rust components (DataHaven runtime and node Rust tests)

name: DataHaven Operator Rust Tests

on:
  workflow_dispatch:
  workflow_call:

# Explicit minimal permissions
permissions:
  contents: read

jobs:
  rust-tests:
    name: Run Operator Rust tests
    runs-on:
      group: DH-runners
    env:
      RUSTC_WRAPPER: "sccache"
      CARGO_INCREMENTAL: "0"
      CARGO_TERM_COLOR: always
      RUSTFLAGS: "-C linker=clang -C link-arg=-fuse-ld=mold"
      SCCACHE_GHA_ENABLED: "true"
    defaults:
      run:
        working-directory: ./operator
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: ./.github/workflows/actions/setup-env
        with:
          cache-key: "TEST"
          install-deps: false

      - name: Set build flags
        run: echo "RUSTFLAGS=${{ env.RUSTFLAGS }} -C linker=clang -C link-arg=-fuse-ld=mold" >> $GITHUB_ENV

      - name: Run tests
        run: cargo test --locked

