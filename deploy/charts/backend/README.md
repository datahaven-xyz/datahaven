# StorageHub MSP Backend Helm Chart

This Helm chart deploys the StorageHub MSP Backend API service that provides REST API access to the StorageHub network data.

## Overview

The StorageHub MSP Backend API:
- Connects to PostgreSQL database for indexed blockchain data
- Connects to RPC nodes for real-time blockchain queries
- Provides REST API endpoints for StorageHub operations
- Supports health checks and metrics endpoints

## Prerequisites

- Kubernetes 1.19+
- Helm 3.2.0+
- Running StorageHub Indexer database (PostgreSQL)
- Running StorageHub RPC node

## Installation

### Using base configuration

```bash
helm install sh-mspbackend ./charts/backend \
  -f ./charts/backend/storagehub/sh-mspbackend.yaml
```

### For Local environment

```bash
helm install sh-mspbackend ./charts/backend \
  -f ./charts/backend/storagehub/sh-mspbackend.yaml \
  -f ./environments/local/sh-mspbackend.yaml \
  -n kt-datahaven-local
```

### For Stagenet environment

```bash
helm install sh-mspbackend ./charts/backend \
  -f ./charts/backend/storagehub/sh-mspbackend.yaml \
  -f ./environments/stagenet/sh-mspbackend.yaml \
  -n datahaven-stagenet
```

## Configuration

### Key Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `image.repository` | Container image repository | `storagehub/backend` |
| `image.tag` | Container image tag | `latest` |
| `replicaCount` | Number of replicas | `1` |
| `service.type` | Kubernetes service type | `ClusterIP` |
| `service.port` | Service port | `3000` |
| `backend.database.url` | PostgreSQL connection URL | `postgresql://...` |
| `backend.rpc.endpoint` | WebSocket RPC endpoint | `ws://sh-idxnode:9944` |
| `ingress.enabled` | Enable ingress | `false` |

### Configuration File

The backend uses a TOML configuration file passed via the `--config` CLI argument. This file is automatically generated from the Helm values and mounted as a ConfigMap.

#### Development (inline database URL):
```yaml
backend:
  database:
    url: postgresql://indexer:password@sh-indexer-db:5432/storagehub_indexer
  rpc:
    endpoint: ws://sh-idxnode:9944
    httpEndpoint: http://sh-idxnode:9933
  args:
    - "--config"
    - "/app/config/config.toml"

configMap:
  enabled: true
```

#### Production (separate database configuration):
```yaml
backend:
  database:
    host: sh-indexer-db
    port: 5432
    name: storagehub_indexer
    user: indexer
    password: production_password  # Note: Consider external secret management
  rpc:
    endpoint: ws://sh-idxnode:9944
    httpEndpoint: http://sh-idxnode:9933
  args:
    - "--config"
    - "/app/config/config.toml"

configMap:
  enabled: true
  extraConfig:
    environment: "production"
    features:
      metrics: true
```

### Environment Variables

Additional environment variables can be configured:

```yaml
backend:
  env:
    LOG_LEVEL: debug
    CACHE_TTL: "300"
```

### Additional Configuration

You can add extra configuration to the generated config.toml file:

```yaml
configMap:
  extraConfig:
    environment: "local"
    features:
      debug: true
      swagger: true
      metrics: true
    customSetting: "value"
```

### CLI Arguments

The `--config` argument is automatically added to point to the generated configuration file. Additional CLI arguments can be specified:

```yaml
backend:
  args:
    - "--config"
    - "/app/config/config.toml"
    - "--log-level"
    - "debug"
    - "--dev-mode"
```

## Accessing the Service

### Local Environment

When deployed with `NodePort` service type:
```bash
# Access via NodePort (configured as 30300 in local environment)
curl http://localhost:30300/api/v1

# Or via ingress if enabled
curl http://api.datahaven.local/api/v1
```

### Stagenet Environment

```bash
# Access via ingress
curl https://api-stagenet.storagehub.io/api/v1
```

## Monitoring

The backend exposes Prometheus metrics on `/metrics` endpoint when enabled:

```yaml
backend:
  env:
    METRICS_ENABLED: "true"
    METRICS_PORT: "9090"
```

## Troubleshooting

### Check pod status
```bash
kubectl get pods -l app.kubernetes.io/name=backend
```

### View logs
```bash
kubectl logs -l app.kubernetes.io/name=backend
```

### Verify database connection
```bash
kubectl exec -it <pod-name> -- nc -zv sh-indexer-db 5432
```

### Verify RPC connection
```bash
kubectl exec -it <pod-name> -- nc -zv sh-idxnode 9944
```

## Uninstallation

```bash
helm uninstall sh-mspbackend -n <namespace>
```