# StorageHub MSP Backend API configuration for Stagenet environment

global:
  environment: stagenet
  namespace: datahaven-stagenet

# Stagenet image configuration
image:
  repository: moonsonglabs/storage-hub-msp-backend
  tag: latest
  pullPolicy: Always

imagePullSecrets:
  - name: ghcr-dockerhub

# Multiple replicas for redundancy
replicaCount: 2

# Service configuration
service:
  type: ClusterIP
  port: 3000
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

# Backend configuration for stagenet
backend:
  database:
    # Note: In production, consider using a more secure approach for credentials
    url: postgresql://indexer:REPLACE_WITH_ACTUAL_PASSWORD@sh-indexer-db:5432/storagehub_indexer
    
  rpc:
    endpoint: ws://sh-idxnode:9944
    httpEndpoint: http://sh-idxnode:9933
    
  env:
    NODE_ENV: staging
    LOG_LEVEL: info
    API_PREFIX: "/api/v1"
    # Rate limiting configuration
    RATE_LIMIT_ENABLED: "true"
    RATE_LIMIT_WINDOW_MS: "60000"
    RATE_LIMIT_MAX_REQUESTS: "200"
    # Cache configuration
    CACHE_ENABLED: "true"
    CACHE_TTL: "300"
    # Monitoring
    METRICS_ENABLED: "true"
    METRICS_PORT: "9090"
    
  # CLI arguments for production
  args:
    - "--config"
    - "/app/config/config.toml"
    - "--enable-metrics"

# Production-ready resources
resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "1000m"

# Enable ingress with SSL
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
  hosts:
    - host: api-stagenet.storagehub.io
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: sh-mspbackend-stagenet-tls
      hosts:
        - api-stagenet.storagehub.io

# Pod disruption budget for high availability
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Anti-affinity to spread pods across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - backend
          topologyKey: kubernetes.io/hostname

# Additional monitoring annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"
  co.elastic.logs/enabled: "true"
  co.elastic.logs/module: "nodejs"

# ConfigMap for stagenet-specific configuration
configMap:
  enabled: true
  extraConfig:
    environment: "stagenet"
    features:
      debug: false
      swagger: true
      metrics: true
      healthCheck: true
    api:
      version: "v1"
      prefix: "/api/v1"
      timeout: 30000
    security:
      helmet: true
      rateLimit: true
      cors: true