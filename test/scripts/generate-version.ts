import { logger } from "utils";
import { parseDeploymentsFile } from "utils/contracts";

/**
 * Generates contracts/src/generated/Version.sol from deployment JSON files
 *
 * NOTE: This generated file is for REFERENCE and TESTING purposes only.
 * The actual contract version is passed as a parameter during deployment.
 * This file provides a centralized view of deployed versions across chains.
 *
 * Following the pattern of generate-contracts.ts for consistency
 */
export const generateVersionFile = async () => {
  logger.info("üìù Generating Version.sol from deployment files...");

  const chains = ["anvil", "hoodi", "ethereum"];
  const versions: Record<string, string> = {};

  // Read versions from all deployment files
  for (const chain of chains) {
    try {
      const deployments = await parseDeploymentsFile(chain);
      const version = (deployments as any).version;

      if (!version) {
        logger.warn(`‚ö†Ô∏è  No version field found in ${chain}.json, using "0.0.0"`);
        versions[chain] = "0.0.0";
      } else {
        versions[chain] = version;
        logger.debug(`  ${chain}: ${version}`);
      }
    } catch (error) {
      logger.warn(`‚ö†Ô∏è  Could not read ${chain}.json: ${error}`);
      versions[chain] = "0.0.0";
    }
  }

  // Generate Solidity library
  const timestamp = new Date().toISOString();
  const solidityContent = `// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.27;

/**
 * @title DataHavenVersions
 * @notice Auto-generated version constants from deployment configurations
 * @dev DO NOT EDIT MANUALLY - Generated by test/scripts/generate-version.ts
 *
 * NOTE: This file is for REFERENCE and TESTING purposes only.
 * Contracts do NOT use these constants - version is passed as a parameter during deployment.
 * This provides a centralized view of deployed versions for tooling and verification.
 *
 * This file is automatically generated from contracts/deployments/{chain}.json files.
 * Each constant represents the deployed version for a specific network.
 *
 * To update: Run 'bun generate:version' in the test/ directory
 * Last generated: ${timestamp}
 */
library DataHavenVersions {
    /// @notice Version deployed on Anvil local testnet (chainId: 31337)
    string internal constant ANVIL_VERSION = "${versions.anvil}";

    /// @notice Version deployed on Holesky testnet (chainId: 560048)
    string internal constant HOODI_VERSION = "${versions.hoodi}";

    /// @notice Version deployed on Ethereum mainnet (chainId: 1)
    string internal constant ETHEREUM_VERSION = "${versions.ethereum}";
}
`;

  // Write to contracts/src/generated/Version.sol
  const outputPath = "../contracts/src/generated/Version.sol";
  await Bun.write(outputPath, solidityContent);

  logger.success(
    `‚úÖ Generated Version.sol with anvil=${versions.anvil}, hoodi=${versions.hoodi}, ethereum=${versions.ethereum}`
  );
};

// Allow direct execution
if (import.meta.main) {
  await generateVersionFile();
}
